name: CI

on:
  
  push:
  workflow_dispatch:

jobs:
  
  build:
    
    runs-on: ubuntu-latest
    steps:
      
      - uses: actions/checkout@v3

      - name: Build      
        run: |
          chmod +x gradlew
          ./gradlew build
          ls -ltrh build/libs

      - name : Run Tests and Generate JaCoCo Report
        run: |
          #./gradlew test jacocoTestReport
          ./gradlew clean test jacocoTestReport jacocoTestCoverageVerification
                    
      - name: SonarCloud Analysis    
        run: |
          chmod +x gradlew
          ./gradlew build sonar -Dsonar.token=${{secrets.TOKEN_SONARCLOUD}}

      - name: Check SonarCloud Quality Gate
        run: |
          status=$(curl -s -u ${{ secrets.SONAR_TOKEN }} -X GET "https://sonarcloud.io/api/qualitygates/project_status?projectKey=DEVOPS-Fundamentos-2023_microservicio-java" | jq -r '.projectStatus.status')
          if [ "$status" != "OK" ]; then
            echo "Quality Gate failed. Stopping the workflow."
            exit 1
          fi
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}    
                
      - name: Docker Login   
        uses: docker/login-action@v2.2.0
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}

      - name: Copia de Jar a Raiz de proyecto
        run: |
          cp $GITHUB_WORKSPACE/build/libs/testing-web-0.0.1-SNAPSHOT.jar .
          chmod 777 testing-web-0.0.1-SNAPSHOT.jar
          ls -lt

      - name: Docker Build
        run: |
          docker build --tag mfigueroah/microservicio-java .
          docker images

      - name: Docker Push
        run: |
          docker push mfigueroah/microservicio-java

  #deploy:
    
    #runs-on: self-hosted
    #needs: build
    #steps:
      
      #- uses: actions/checkout@v3

      #- name: Deploy to Minukube
      #  run: |
      #    kubectl apply -f deployment.yml
    

    

          
 
       
